---
title: "Validations by simulation"
date: "`r Sys.Date()`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include=FALSE)
options(digits=3, stringsAsFactors=FALSE)
library(ezlimma)
library(ezlimmaplot)
library(Mesa)
```

We validate the ability of `hitman` and `mesa` to control their false positive rate (*size*) and have high rate of detecting true positives (*power*) via simulations, where we know the truth.

# Mediation

We simulate our mediation methodsand compare them against the benchmark simulation of several mediation methods from Barfield et al. (2017), Table 1, for N=50.

## Validating our simulations

We are simulating using the internal `ezlimma` function `ezlimma:::sim_barfield`. To validate that our this function provides results consistent with the simulations in Barfield et al. (2017), we compared Barfield et al.'s simulations with the joint significance test to our simulations with the joint significance test.   

We implemented the joint significance test in R, available as the internal `ezlimma` function `ezlimma:::joint_signif_mediation`. We first tested that this function gave the same results as another implemention of this test in R, the funciton `mdt_simple` in package `JSmediation` (available upon reasonable request). Here, we validate that our implementation matches Barfield et al. (2017) Table 1. This calculation takes ~5 min on my desktop PC. 

```{r, eval=FALSE}
nsim <- 10**4
prop.sig.js <- ezlimma:::sim_barfield(med.fcn = joint_signif_mediation, b1t2.v=c(0, 0.14, 0.39), nsim = nsim)
write.csv(prop.sig.js, paste0("./validation/sim_jointsig_nsamp50_nsim", nsim, ".csv"), na="")
```

## Hitman

This calculation takes ~30 min on my desktop PC. Our simulation results are at [sim_hitman_nsamp50_nsim10000.csv](./validation/sim_hitman_nsamp50_nsim10000.csv).

```{r, eval=FALSE}
nsim <- 10**4
start.hit <- Sys.time()
prop.sig.hit <- ezlimma:::sim_barfield(med.fcn = hitman, b1t2.v=c(0, 0.14, 0.39), nsim = nsim, ngene=99)
stop.hit <- Sys.time()
hit.time <- stop.hit-start.hit

write.csv(prop.sig.hit, paste0("./validation/sim_hitman_nsamp50_nsim", nsim, ".csv"), na="")
```

## Counterfactual

From `mediation` package.

```{r, eval=FALSE}
nsim <- 10**4
start.med <- Sys.time()
prop.sig.med <- ezlimma:::sim_barfield(med.fcn = ezmediation, b1t2.v=c(0, 0.14, 0.39), nsim = nsim, ngene=99)
stop.med <- Sys.time()
med.time <- stop.med-start.med

write.csv(prop.sig.med, paste0("./validation/sim_mediation_nsamp50_nsim", nsim, ".csv"), na="")
```

# MSA

We simulate data to test multiple methods for Mediator Set Analysis (MSA), including our own (Mesa), the global mediation test, and a fisher test. For this we use our function `sim_msa`.

```{r}
# Declare variables.
nsample <- 8
nperm <- 10**3
nsim <- 50
effect.v <- 0:3

load("data/smpdb_gmat.rda")
```

Test mesa

```{r, eval=FALSE}
# b/c i add 1 to avoid p=0, more nperm --> lower p
spm <- Mesa::sim_msa(msea, Gmat=smpdb_gmat, nsample=nsample, nsim=nsim, nperm=nperm, effect.v = effect.v, ncores=1)
write.csv(spm[1,, drop=FALSE], paste0("./validation/sim_msa_nperm", nperm, "_nsim", nsim, ".csv"), na="")
```

Test global mediation test

```{r, eval=FALSE}
# b/c i add 1 to avoid p=0, more nperm --> lower p
spm <- Mesa::sim_msa(Gmat=smpdb_gmat, nsample=nsample, nsim=nsim, nperm=nperm, effect.v = effect.v)
write.csv(spm[1,, drop=FALSE], paste0("./validation/sim_gmt_nperm", nperm, "_nsim", nsim, ".csv"), na="")
```

Run hitman fisher? better on function that can be sent to sim_msa.

```{r, eval=FALSE}
sfh <- ezlimma:::sim_fisher_hitman(G=g.smpdb[1:2], E = exposure, all.feats = all.feats, nsim=200, 
                                   effect.v = c(0, 0.01), prop.other.sig = 0.25)
head(sfh)
```

# References
Barfield R, Shen J, Just AC, Vokonas PS, Schwartz J, Baccarelli AA, VanderWeele TJ, Lin X. Testing for the indirect effect under the null for genome-wide mediation analyses. Genet Epidemiol. 2017 Dec;41(8):824-833.
