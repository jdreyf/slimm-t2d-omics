---
title: "Validations by simulation"
date: "`r Sys.Date()`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include=FALSE)
options(digits=3, stringsAsFactors=FALSE)
library(ezlimma)
library(PANTS)
```

We validate the ability of each of our methods (`hitman`, `lotman`, and `pants`) to control their false positive rate (*size*) and have high rate of detecting true positives (*power*) via simulations, where we know the truth.

# Mediation

We simulate our mediation methods using the benchmark simulation from Barfield et al. (2017), using an internal function of `ezlimma`.

## Lotman

This calculation takes ~10 min on my desktop PC. Our simulation results are at [sim_lotman_nsamp50_nsim10000.csv](./results/sim_lotman_nsamp50_nsim10000.csv).

```{r, eval=FALSE}
prop.sig.mat <- ezlimma:::sim_barfield(med.fcn = lotman, b1t2.v=c(0, 0.14, 0.39), nsim = 10**4)
write.csv(prop.sig.mat, "./results/sim_lotman_nsamp50_nsim10000.csv", na="")
```

## Hitman

This calculation takes ~30 min on my desktop PC. Our simulation results are at [sim_hitman_nsamp50_nsim10000.csv](./results/sim_hitman_nsamp50_nsim10000.csv).

```{r, eval=FALSE}
prop.sig.mat <- ezlimma:::sim_barfield(med.fcn = hitman, b1t2.v=c(0, 0.14, 0.39), nsim = 10**4, ngene=99)
write.csv(prop.sig.mat, "./results/sim_hitman_nsamp50_nsim10000.csv", na="")
```

## Joint Significance

We implemented the joint significance test in R to compare our mediation methods to. We first tested that our results were identical to those from the funciton `mdt_simple` in package `JSmediation`. Here, we validate that our implementation matches Barfield et al. (2017). This calculation takes ~5 min on my desktop PC. 

```{r, eval=FALSE}
prop.sig.mat <- ezlimma:::sim_barfield(med.fcn = joint_signif_mediation, b1t2.v=c(0, 0.14, 0.39), nsim = 10**4)
write.csv(prop.sig.mat, "./results/sim_jointsig_nsamp50_nsim10000.csv", na="")
```

# Pants

Validate group contrasts & correlation.

```{r, eval=FALSE}
data("pc9")
gr <- igraph::simplify(igraph::graph_from_edgelist(pc9, directed = FALSE))
ker <- graph2kernel(gr = gr)
data("smpdb_gmat")
nsample <- 20
nperm <- 10**4

# b/c i add 1 to avoid p=0, more nperm --> lower p
# contrasts
phenotype <- setNames(rep(c("trt", "ctrl"), each=nsample/2), paste0("s", 1:nsample))
sp <- PANTS:::sim_pants(Gmat=smpdb_gmat, phenotype = phenotype, nsim=10, nperm=nperm, effect.v = c(0, 0.2), 
                        ker=ker, ncores=8)
write.csv(sp[1,, drop=FALSE], paste0("./results/sim_pants_contrasts_nperm", nperm, ".csv"), na="")

# cor
set.seed(1)
phenotype = setNames(rnorm(nsample), paste0("s", 1:nsample))
sp <- PANTS:::sim_pants(Gmat=smpdb_gmat, phenotype = phenotype, nsim=100, nperm=nperm, effect.v = c(0, 0.2), 
                        ker=ker, ncores=8, type="correlation")
write.csv(sp[1,, drop=FALSE], "./results/sim_pants_correlation.csv", na="")
```

# References
Barfield R, Shen J, Just AC, Vokonas PS, Schwartz J, Baccarelli AA, VanderWeele TJ, Lin X. Testing for the indirect 
effect under the null for genome-wide mediation analyses. Genet Epidemiol. 2017 Dec;41(8):824-833.