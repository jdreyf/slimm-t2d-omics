---
title: "Validations by simulation"
date: "`r Sys.Date()`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include=FALSE)
options(digits=3, stringsAsFactors=FALSE)
library(ezlimma)
library(ezlimmaplot)
library(Pame)
```

We validate the ability of each of our methods (`hitman`, `lotman`, and `pame`) to control their false positive rate (*size*) and have high rate of detecting true positives (*power*) via simulations, where we know the truth.

# Mediation

We simulate our mediation methodsand compare them against the benchmark simulation of several mediation methods from Barfield et al. (2017),  Table 1, for N=50.

## Validating our simulations

We are simulating using the internal `ezlimma` function `ezlimma:::sim_barfield`. To validate that our this function provides results consistent with the simulations in Barfield et al. (2017), we compared Barfield et al.'s simulations with the joint significance test to our simulations with the joint significance test.   

We implemented the joint significance test in R, available as the internal `ezlimma` function `ezlimma:::joint_signif_mediation`. We first tested that this function gave the same results as another implemention of this test in R, the funciton `mdt_simple` in package `JSmediation` (available upon reasonable request). Here, we validate that our implementation matches Barfield et al. (2017) Table 1. This calculation takes ~5 min on my desktop PC. 

```{r, eval=FALSE}
nsim <- 10**4
prop.sig.js <- ezlimma:::sim_barfield(med.fcn = joint_signif_mediation, b1t2.v=c(0, 0.14, 0.39), nsim = nsim)
write.csv(prop.sig.js, paste0("./validation/sim_jointsig_nsamp50_nsim", nsim, ".csv"), na="")
```

## Lotman

This calculation takes ~10 min on my desktop PC. Our simulation results are at [sim_lotman_nsamp50_nsim10000.csv](./validation/sim_lotman_nsamp50_nsim10000.csv).

```{r, eval=FALSE}
nsim <- 10**4

start.lot <- Sys.time()
prop.sig.lot <- ezlimma:::sim_barfield(med.fcn = lotman, b1t2.v=c(0, 0.14, 0.39), nsim = nsim)
stop.lot <- Sys.time()

write.csv(prop.sig.lot, paste0("./validation/sim_lotman_nsamp50_nsim", nsim, ".csv"), na="")
```

This function took `r stop.lot-start.lot`.

## Hitman

This calculation takes ~30 min on my desktop PC. Our simulation results are at [sim_hitman_nsamp50_nsim10000.csv](./validation/sim_hitman_nsamp50_nsim10000.csv).

```{r, eval=FALSE}
nsim <- 10**4
start.hit <- Sys.time()
prop.sig.hit <- ezlimma:::sim_barfield(med.fcn = hitman, b1t2.v=c(0, 0.14, 0.39), nsim = nsim, ngene=99)
stop.hit <- Sys.time()
hit.time <- stop.hit-start.hit

write.csv(prop.sig.hit, paste0("./validation/sim_hitman_nsamp50_nsim", nsim, ".csv"), na="")
```

## Counterfactual

From `mediation` package.

```{r, eval=FALSE}
nsim <- 10**4
start.med <- Sys.time()
prop.sig.med <- ezlimma:::sim_barfield(med.fcn = ezmediation, b1t2.v=c(0, 0.14, 0.39), nsim = nsim, ngene=99)
stop.med <- Sys.time()
med.time <- stop.med-start.med

write.csv(prop.sig.med, paste0("./validation/sim_mediation_nsamp50_nsim", nsim, ".csv"), na="")
```

# Pame

Declare variables.

```{r}
nsample <- 20
nperm <- 10**3
nsim <- 50

load("data/smpdb_gmat.rda")
g.smpdb <- Gmat2gmt(smpdb_gmat)
all.feats <- rownames(smpdb_gmat)
exposure <- setNames(rep(0:1, each=nsample/2), paste0("s", 1:nsample))
```

Run pame on simulations using internal `Pame` functions.

```{r, eval=FALSE}
# b/c i add 1 to avoid p=0, more nperm --> lower p
spm <- Pane:::sim_pane(Gmat=smpdb_gmat, exposure = exposure, nsim=nsim, nperm=nperm, effect.v = c(0, 0.1), ncores=4)
write.csv(spm[1,, drop=FALSE], paste0("./validation/sim_pane_nperm", nperm, "_nsim", nsim, ".csv"), na="")
```

Run hitman fisher

```{r, eval=FALSE}
sfh <- ezlimma:::sim_fisher_hitman(G=g.smpdb[1:2], E = exposure, all.feats = all.feats, nsim=200, 
                                   effect.v = c(0, 0.01), prop.other.sig = 0.25)
head(sfh)
```

Run ORA on hitman mediation on simulations using `sim_ora_mediation`.

```{r}
som <- sim_ora_mediation(G=g.smpdb, exposure = exposure, nsim=4*nsim, effect.v = c(0, 0.1), all.feats=all.feats)
write.csv(som[1,, drop=FALSE], paste0(".validation/sim_ora_mediation_nsim", nsim, ".csv"), na="")
```


# References
Barfield R, Shen J, Just AC, Vokonas PS, Schwartz J, Baccarelli AA, VanderWeele TJ, Lin X. Testing for the indirect effect under the null for genome-wide mediation analyses. Genet Epidemiol. 2017 Dec;41(8):824-833.