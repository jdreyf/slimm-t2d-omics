---
title: Analyze omics from SLIMM-T2D trial
author: "jd"
date: "`r Sys.Date()`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include=FALSE)
options(digits=3, stringsAsFactors=FALSE)
source("R/make_diff_mat.R")

library(devtools)
library(ggplot2)
library(knitr)
library(zeallot)

# instructions to install the latest version of these R packages are in README at: https://github.com/jdreyf/PANTS
# however, to install version of PANTS used in this paper: 
# remotes::install_github(repo="jdreyf/PANTS@v0.0.4.9001", build_opts = c("--no-resave-data", "--no-manual"))
library(limma)
library(ezlimma)
library(ezlimmaplot)
library(Pame)

source("R/ezmediate.R")
```

# Read data and take the difference from baseline per person

Clinical metadata at [clin_metadata.csv](./data/clin_metadata.csv). This file also used for uploads to GEO. Here, change colnames in workflow, so can use them more easily in ggplot2. After taking differences of phenotypes, we remove individual points from R object *diff.pheno*, such as Topaz_3, who have NA in every measure.

The original SOMAscan dataset was parsed to write [soma_annot.csv](./data/soma_annot.csv) and log2-transformed to write [soma_mat.csv](./data/soma_mat.csv).

The original metabolomics dataset was parsed, filtered, and log2-transformed to write [met_mat_norm.csv](./data/met_mat_norm.csv). Annotations for metabolites did not originally have CHEBI annotations, but these were needed for Pathaway analysis via network-smoothing to match our network (Pathway Commons PC9) and pathway database (SMPDB), so we added these automatically using CTSgetR. However, CTSgetR wasn't given the chirality of many compounds, so we found that 3-hydroxyisobutyrate had CHEBI:11805, whereas SMPDB had (S)-3-Hydroxyisobutyric acid (CHEBI:37373), so we manually fixed 3-hydroxyisobutyrate to have CHEBI:37373, and wrote  [met_annot_with_chebi.csv](./data/met_annot_with_chebi.csv).

```{r read}
pheno <- read.csv("data/clin_metadata.csv", row.names = 1, check.names = FALSE)
clin.names.map <- data.frame(full_name=colnames(pheno))
#make colnames easier to use in ggplot2, but keep a mapping to long names
colnames(pheno) <- sub("Group", "arm", 
                       gsub(" ", "_", 
                            gsub(":.+| \\(.+", "", colnames(pheno))))
rownames(clin.names.map) <- clin.names.map$abbrev <- colnames(pheno)
pheno$grp <- paste(pheno$arm, pheno$Mo, sep="_")

soma.mat <- read.csv("../slimm-t2d-omics-data/soma_mat.csv", row.names=1)
diff.soma.mat <- make_diff_mat(soma.mat)
soma.annot <- read.csv("data/soma_annot.csv", row.names = 1)

met.mat <- read.csv("../slimm-t2d-omics-data/met_mat_norm.csv", row.names=1)
diff.met.mat <- make_diff_mat(met.mat)
met.annot <- read.csv("data/met_annot_with_chebi.csv", row.names = 1)
```

```{r grp}
mo.v <- c(0, 3, 12, 24, 36)
contr.v1 <- paste0('RYGB_', mo.v, '-DWM_', mo.v)
names(contr.v1) <- paste0('RYGBvsDWMat', mo.v, 'mo')

avg.grps <- paste0(rep(c("DWM", "RYGB"), each=length(mo.v)), "_", mo.v, ".avg")
grp <- setNames(pheno$grp, nm=rownames(pheno))
```

Samples in 12mo metabolomics and proteomics are identical, so create diff_mats at 1 year. Also, create a combined annotation.

```{r dan12}
dsoma12 <- diff.soma.mat[,grep("_12$", colnames(diff.soma.mat))]
dmet12 <- diff.met.mat[,grep("_12$", colnames(diff.met.mat))]
```

Calculate metadata differences from baseline and remove samples with too many NAs, who shouldn't be used in Hitman.

```{r diff.pheno}
diff.pheno <- t(make_diff_mat(t(pheno[,setdiff(colnames(pheno), c('Acrostic', 'arm', 'Height', 'Mo', 'grp'))])))
# dmcure has NA as 9 and is a computed column, so doesn't need to be tested in na.row
na.rows <- which(rowMeans(is.na(diff.pheno[,setdiff(colnames(diff.pheno), c("month", "dmcure"))])) == 1)
diff.pheno <- diff.pheno[-na.rows,]
diff.pheno <- data.frame(diff.pheno, arm=pheno[rownames(diff.pheno), c("arm")], grp=pheno[rownames(diff.pheno), c("grp")],
                         check.names = FALSE)
diff.pheno3 <- diff.pheno[grep("_3$", rownames(diff.pheno)),]
diff.pheno12 <- diff.pheno[grep("_12$", rownames(diff.pheno)),]
rownames(diff.pheno12) <- gsub("_12$", "", rownames(diff.pheno12))
```

# Differential abundance between groups

Analyze differences between groups at each time point, and these differences after taking each person's difference from baseline, with and without adjusting for each person's change in BMI.

```{r des.bmi}
des.diff.bmi <- model.matrix(object = ~0+grp+BMI, data=diff.pheno)
colnames(des.diff.bmi) <- sub("grp", "", colnames(des.diff.bmi), fixed=TRUE)
des.diff.bmi <- des.diff.bmi[,setdiff(colnames(des.diff.bmi), c("DWM_18", "RYGB_18"))]

contr.bmi <- contr.v1[-1]
names(contr.bmi) <- paste0(names(contr.bmi), "_bmi")
```

## Proteome

```{r soma ezl}
#for means, use initial mat
soma.stats <- limma_contrasts(soma.mat, grp=grp[colnames(soma.mat)], contr.v1)
#order avg cols
avg.cols <- intersect(avg.grps, grep("avg$", colnames(soma.stats), value = TRUE))
t0.cols <- grep("^RYGBvsDWMat0mo", colnames(soma.stats), value = TRUE)

soma.diff.stats <- limma_contrasts(diff.soma.mat, grp=grp[colnames(diff.soma.mat)], contr=contr.v1[-1], add.means = FALSE)
soma.bmi.diff.stats <- limma_contrasts(diff.soma.mat, design = des.diff.bmi[colnames(diff.soma.mat),], 
                                              contr=contr.bmi, add.means = FALSE)

soma.tab <- data.frame(soma.stats[rownames(soma.diff.stats), c(avg.cols, t0.cols)], soma.diff.stats, 
                       soma.bmi.diff.stats[rownames(soma.diff.stats),], soma.annot[rownames(soma.diff.stats),])
write.csv(df_signif(soma.tab), "results/soma_supp_table.csv")
```

The Soma supp table with means per group per time point and statistics on differences between groups on differences from baseline is at [soma_supp_table.csv](./results/soma_supp_table.csv). 

```{r soma_venns}
setwd("./results")
soma.venn <- ezvenn(soma.tab, prefix.v = names(contr.v1)[-1], fdr.cutoff = 0.05, name="soma_FDR05", plot = FALSE)
soma.sig <- rownames(soma.venn)[rowSums(abs(soma.venn)) > 0]
soma.venn.df <- data.frame(soma.venn[soma.sig,], soma.annot[soma.sig, 1:7])
write.csv(soma.venn.df, "soma_FDR05_venn.csv")
setwd("..")
```

A table representing a Venn diagram of proteomics using FDR = 0.05 is at  [soma_FDR05_venn.csv](./results/soma_FDR05_venn.csv).

## Metabolome

```{r met ezl}
#mets don't have 24mo time
met.stats <- limma_contrasts(met.mat, grp=grp[colnames(met.mat)], contr.v1[-4])
met.diff.stats <- limma_contrasts(diff.met.mat, grp=grp[colnames(diff.met.mat)], contr=contr.v1[-c(1, 4)], add.means = FALSE)
des.met.diff.bmi <- des.diff.bmi[,setdiff(colnames(des.diff.bmi), c("DWM_24", "RYGB_24"))]
met.bmi.diff.stats <- signif(limma_contrasts(diff.met.mat, design = des.met.diff.bmi[colnames(diff.met.mat),], 
                                              contr=contr.bmi[-3], add.means = FALSE), 3)
#order avg cols
avg.cols <- intersect(avg.grps, grep("avg$", colnames(met.stats), value = TRUE))
t0.cols <- grep("^RYGBvsDWMat0mo", colnames(met.stats), value = TRUE)

met.tab <- data.frame(met.stats[rownames(met.diff.stats), c(avg.cols, t0.cols)], met.diff.stats, 
                      met.bmi.diff.stats[rownames(met.diff.stats),], met.annot[rownames(met.diff.stats),])
write.csv(df_signif(met.tab), "./results/met_supp_table.csv", na="")
```

Analyze differences between groups at each time point, and these differences after taking each person's difference from baseline. The met supp table with means per group per time point and statistics on differences between groups on differences from baseline is at [met_supp_table.csv](./results/met_supp_table.csv).

```{r met_venns}
setwd("./results")
met.venn <- ezvenn(met.tab, prefix.v = names(contr.v1)[-c(1, 4)], fdr.cutoff = 0.05, name="met_FDR05", plot = FALSE)
met.sig <- rownames(met.venn)[rowSums(abs(met.venn)) > 0]
met.venn.df <- data.frame(met.venn[met.sig,], met.annot[met.sig,])
write.csv(met.venn.df, "met_FDR05_venn.csv")
setwd("..")
```

A table representing a Venn diagram of metabolomics using FDR = 0.05 is at  [met_FDR05_venn.csv](./results/met_FDR05_venn.csv).

# Differential abundance remission at 3 years within RYGB

Analyze each person's analyte difference from baseline at 3mo between those who achieved glycemic endpoints (coded as *dmcure*) at 36mo and those who did not within RYGB.

```{r dmcure}
diff.pheno36 <- diff.pheno[grep("_36$", rownames(diff.pheno)),]
# code 9 indicates NA
diff.pheno36$dmcure[diff.pheno36$dmcure==9] <- NA
diff.pheno36 <- diff.pheno36[!is.na(diff.pheno36$dmcure),]
rownames(diff.pheno36) <- gsub("_36$", "", rownames(diff.pheno36))

dp36.rygb <- diff.pheno36[diff.pheno36$arm=="RYGB",]
dp36.rygb$dmcure.char <- ifelse(dp36.rygb$dmcure, "dmcure", "not_dmcure")
contr.dmc <- c(dmcure_vs_not="dmcure-not_dmcure")
```

## Proteome

```{r soma dmcure ezl}
nms.tmp <- intersect(gsub("_3$", "", grep("_3$", colnames(diff.soma.mat), value=TRUE)), rownames(dp36.rygb))
soma.dmc.stats <- limma_contrasts(diff.soma.mat[,paste0(nms.tmp, "_3")], grp=dp36.rygb[nms.tmp, "dmcure.char"], 
                                  contrast.v = contr.dmc)
soma.dmc.df <- data.frame(signif(soma.dmc.stats, 3), soma.annot[rownames(soma.dmc.stats),])
write.csv(soma.dmc.df, "./results/soma_dmcure_table.csv")
```

The Soma table with statistics on differences in remission is at [soma_dmcure_table.csv](./results/soma_dmcure_table.csv). The minimum FDR is `r signif(min(soma.dmc.stats$dmcure_vs_not.FDR), 3)`.

## Metabolome

```{r met dmcure ezl}
nms.tmp <- intersect(gsub("_3$", "", grep("_3$", colnames(diff.met.mat), value=TRUE)), rownames(dp36.rygb))
met.dmc.stats <- limma_contrasts(diff.met.mat[,paste0(nms.tmp, "_3")], grp=dp36.rygb[nms.tmp, "dmcure.char"], 
                                  contrast.v = contr.dmc)
met.dmc.df <- data.frame(signif(met.dmc.stats, 3), met.annot[rownames(met.dmc.stats),])
write.csv(met.dmc.df, "./results/met_dmcure_table.csv")
```

The met table with statistics on differences is at [met_dmcure_table.csv](./results/met_dmcure_table.csv). The minimum FDR is `r signif(min(met.dmc.stats$dmcure_vs_not.FDR), 3)`.

# Hitman/Lotman

We apply Hitman/Lotman to 12mo outcome change from baseline using change at 3mo from baseline as mediators and arm as exposure. The results of these mediation tests are written as CSVs to [results](./results/) folder using the naming convention outcome-timepoint_vs_mediator-timepoint_hitman, such as "HbA1c12_vs_soma3_hitman.csv," whose *EMY* columns hold the overall p-values and FDRs.

## HbA1c

We apply Hitman/Lotman to 12mo HbA1c change using change at 3mo from baseline in analytes and clinical parameters as mediators.

```{r hm_a1c_3}
#soma
nms.tmp <- intersect(gsub("_3$", "", grep("_3$", colnames(diff.soma.mat), value=TRUE)), rownames(diff.pheno12))
hm.soma <- hitman(E=as.numeric(diff.pheno12[nms.tmp, "arm"]=="RYGB"), 
                  M=diff.soma.mat[,paste0(nms.tmp, "_3")], 
                  Y=diff.pheno12[nms.tmp, "HbA1c"])
hm.a1c.soma.df <- data.frame(signif(hm.soma, 3), soma.annot[rownames(hm.soma),])
write.csv(hm.a1c.soma.df, "./results/HbA1c12_vs_soma3_hitman.csv")
#met
nms.tmp <- intersect(gsub("_3$", "", grep("_3$", colnames(diff.met.mat), value=TRUE)), rownames(diff.pheno12))
hm.met <- hitman(E=as.numeric(diff.pheno12[nms.tmp, "arm"]=="RYGB"), M=diff.met.mat[,paste0(nms.tmp, "_3")], 
                  Y=diff.pheno12[nms.tmp, "HbA1c"])
hm.a1c.met.df <- data.frame(signif(hm.met, 3), met.annot[rownames(hm.met),])
write.csv(hm.a1c.met.df, "./results/HbA1c12_vs_met3_hitman.csv")

#clinical
#remove: arm & grp not a difference; creatinine not measured at 3mo
rm.cols <- c("arm", "grp", grep("Creatinine", colnames(diff.pheno3), value=TRUE))
diff.pheno3 <- diff.pheno3[,setdiff(colnames(diff.pheno3), rm.cols)]
rownames(diff.pheno3) <- gsub("_3$", "", rownames(diff.pheno3))
diff.pheno3 <- diff.pheno3[intersect(rownames(diff.pheno3), rownames(diff.pheno12)),]
#diff.pheno3 has TOPAZ, but TOPAZ has all NAs at 12mo
arm.v <- setNames(as.numeric(pheno[paste0(rownames(diff.pheno3), "_0"), "arm"]=="RYGB"), nm=rownames(diff.pheno3))
HbA1c <- setNames(diff.pheno12[rownames(diff.pheno3), "HbA1c"], nm=rownames(diff.pheno3))

# ezmediate gives p=0, which is not correct, even with 10**4 simulations
clin3.hm <- hitman(E=arm.v, M=t(diff.pheno3), Y=HbA1c)
write.csv(signif(clin3.hm, 3), "./results/HbA1c12_vs_clin3_hitman.csv", na="")
```

### Compare clinical vs analytes

## HbA1c
```{r}
hm.a1c.soma.df.ss <- hm.a1c.soma.df[hm.a1c.soma.df$EMY.p < clin3.hm[1, "EMY.p"] & 
                                      hm.a1c.soma.df$EMY.FDR < clin3.hm[1, "EMY.FDR"],]
pr <- rownames(hm.a1c.soma.df.ss)
hm.soma.top <- data.frame(probe=pr, ratio3=fc2ratio(soma.stats[pr, "RYGBvsDWMat3mo.FC"]),
                          nm=hm.a1c.soma.df.ss$TargetFullName, 
                          EntrezGeneSymbol=hm.a1c.soma.df.ss$EntrezGeneSymbol)

hm.a1c.met.df.ss <- hm.a1c.met.df[hm.a1c.met.df$EMY.p < clin3.hm[1, "EMY.p"] & 
                                      hm.a1c.met.df$EMY.FDR < clin3.hm[1, "EMY.FDR"],]
```

The protein analytes more significant in p-value & FDR than any clinical mediator are: `r kable(hm.soma.top)`

The metabolite mediators are `r hm.a1c.met.df.ss$BIOCHEMICAL`

## HOMA-IR

We apply Hitman to 12mo HOMA-IR change using 3mo analyte change as mediators.

```{r hm_homair_3}
#soma
nms.tmp <- intersect(gsub("_3$", "", grep("_3$", colnames(diff.soma.mat), value=TRUE)),
                     rownames(diff.pheno12)[!is.na(diff.pheno12$homair)])
hm.soma <- hitman(E=as.numeric(diff.pheno12[nms.tmp, "arm"]=="DWM"), 
                  M=diff.soma.mat[,paste0(nms.tmp, "_3")], 
                  Y=diff.pheno12[nms.tmp, "homair"])
hm.soma.df <- data.frame(signif(hm.soma, 3), soma.annot[rownames(hm.soma),])
write.csv(hm.soma.df, paste0("./results/homair12_vs_soma3_hitman.csv"))
#met
nms.tmp <- intersect(gsub("_3$", "", grep("_3$", colnames(diff.met.mat), value=TRUE)),
                     rownames(diff.pheno12)[!is.na(diff.pheno12$homair)])
hm.met <- hitman(E=as.numeric(diff.pheno12[nms.tmp, "arm"]=="DWM"), M=diff.met.mat[,paste0(nms.tmp, "_3")], 
                  Y=diff.pheno12[nms.tmp, "homair"])
hm.met.df <- data.frame(signif(hm.met, 3), met.annot[rownames(hm.met),])
write.csv(hm.met.df, paste0("./results/homair12_vs_met3_hitman.csv"))
```

## dins030

We apply Hitman to dins030 [change in insulin from 0 to 30 min in mixed-meal tolerance test (mcU/ml)] change at 12mo from baseline using 3mo analyte change from baseline as mediators.

```{r hm_dins030_3}
#soma
nms.tmp <- intersect(gsub("_3$", "", grep("_3$", colnames(diff.soma.mat), value=TRUE)),
                     rownames(diff.pheno12)[!is.na(diff.pheno12$dins030)])
hm.soma <- hitman(E=as.numeric(diff.pheno12[nms.tmp, "arm"]=="DWM"), 
                  M=diff.soma.mat[,paste0(nms.tmp, "_3")], 
                  Y=diff.pheno12[nms.tmp, "dins030"])
hm.soma.df <- data.frame(signif(hm.soma, 3), soma.annot[rownames(hm.soma),])
write.csv(hm.soma.df, paste0("./results/dins030_12_vs_soma3_hitman.csv"))
#met
nms.tmp <- intersect(gsub("_3$", "", grep("_3$", colnames(diff.met.mat), value=TRUE)),
                     rownames(diff.pheno12)[!is.na(diff.pheno12$dins030)])
hm.met <- hitman(E=as.numeric(diff.pheno12[nms.tmp, "arm"]=="DWM"), M=diff.met.mat[,paste0(nms.tmp, "_3")], 
                  Y=diff.pheno12[nms.tmp, "dins030"])
hm.met.df <- data.frame(signif(hm.met, 3), met.annot[rownames(hm.met),])
write.csv(hm.met.df, paste0("./results/dins030_12_vs_met3_hitman.csv"))
```

# Correlate soma vs. met

We correlate top somalogic proteins with top metabolites.

```{r corsm}
nms.tmp <- intersect(grep("_3$", colnames(diff.soma.mat), value=TRUE),
                     grep("_3$", colnames(diff.met.mat), value=TRUE))

mv <- read.csv("results/met_FDR05_venn.csv", row.names = 1)
top.met <- rownames(mv)[order(met.annot[rownames(mv), "BIOCHEMICAL"])]
sv <- read.csv("results/soma_FDR05_venn.csv", row.names = 1)
top.soma <- rownames(sv)[order(soma.annot[rownames(sv), "EntrezGeneSymbol"])]

diff.soma.mat3.ss <- data.matrix(diff.soma.mat[top.soma, nms.tmp])
rownames(diff.soma.mat3.ss) <- soma.annot[rownames(diff.soma.mat3.ss), "EntrezGeneSymbol"]
diff.soma.mat3.ss <- diff.soma.mat3.ss[!duplicated(rownames(diff.soma.mat3.ss)),]

diff.met.mat3.ss <- data.matrix(diff.met.mat[top.met, nms.tmp])
rownames(diff.met.mat3.ss) <- met.annot[rownames(diff.met.mat3.ss), "BIOCHEMICAL"]
```

```{r build_corr_mat}
dimnms <- list(rownames(diff.soma.mat3.ss), rownames(diff.met.mat3.ss), c("r", "p", "FDR"))
cor.array <- array(data=NA, dim = sapply(dimnms, length), dimnames=dimnms)
for (soma.row in rownames(diff.soma.mat3.ss)){
  for (met.row in rownames(diff.met.mat3.ss)){
    ct <- cor.test(x=diff.soma.mat3.ss[soma.row,], y=diff.met.mat3.ss[met.row,])
    cor.array[soma.row, met.row, "r"] <- ct$estimate
    cor.array[soma.row, met.row, "p"] <- ct$p.value
  }
}
cor.array[,, "FDR"] <- p.adjust(cor.array[,, "p"], method = "BH")

cor.r <- signif(cor.array[,,"r"], 3)
cor.r.out <- cbind(cor.r, NA, "NOTE: p=0.05 corresponds to |r|=0.33 & FDR=0.24"=NA)
colnames(cor.r.out)[(ncol(cor.r.out)-1)] <- NA
write.csv(t(cor.r.out), "results/soma_met_corr_coeffs.csv")
```

# Pathways

For pathway input data, differences from baseline are combined for people who have both somascan & metabolomics. Analytes are subset and summarized (by averaging over analytes with the same ID) to match network, for network plotting.

We plot the top pathways. The t-statistics from ezlimma have sufficiently many degrees of freedom to be approximately z-scores, which are better known, so we annotate them as z-scores. For a network plotting of differences, we use Pathway Commons PC9 and SMPDB files downloaded around 2016.

```{r net_data}
load("data/pc9.rda")
gr <- igraph::simplify(igraph::graph_from_edgelist(pc9, directed = FALSE))
load("data/smpdb_gmat.rda")
# smpdb_gmat <- smpdb_gmat[setdiff(rownames(smpdb_gmat), "CHEBI:15377"),]
smpdb_gmt <- Gmat2gmt(smpdb_gmat)
```

We map ChEBI IDs in PC9 to chemical names, so that we can show the names in our network plots.

```{r chebi_map}
# file created in gb_ww_net_integration
chebi.map <- read.csv('data/chebi_map_v2.csv', row.names=1)
#turn into a named vector
chebi.map <- setNames(chebi.map[,1], rownames(chebi.map))
chebi.map[which(chebi.map=='')] <- names(chebi.map)[which(chebi.map=='')]
```

## Roast between-group

We write the z-score for the between-arm comparison of each analyte's 3 month difference from baseline from `ezlimma::limma_contrasts` to use in results.

```{r deltas}
# diff_mat file created in gb_ww_net_integration
diff.mat3 <- read.csv('../slimm-t2d-omics-data/soma_and_met_diff_mat.csv', row.names=1)

#need to eval this for below
grp.v <- pheno[paste0(colnames(diff.mat3), "_0"), "arm"]
contr.v <- c(RYGBvsDWM="RYGB-DWM")

#feature (analyte) stats from ezlimma
fs <- limma_contrasts(diff.mat3, grp=grp.v, contrast.v = c(RYGBvsDWM="RYGB-DWM"), cols=c("t", "P.Value", "adj.P.Val"))
fs.df <- data.frame(signif(fs, 4), CHEBI=chebi.map[rownames(fs)])
write.csv(fs.df, "results/deltadelta_t.csv")
```

Run roast.

```{r roast, eval=FALSE}
# read in objects with prepare_pame_on_o2.Rmd
setwd("./results")
fs <- read.csv("deltadelta_t.csv", row.names = 1)
G.smpdb <- Gmat2gmt(smpdb_gmat)
nrot <- 2*10**5
res <- roast_contrasts(object=diff.mat3, G=G.smpdb, feat.tab=fs, grp=grp.v, contrast.v=contr.v, fun="mroast", 
                       nrot=nrot, name = paste0("RYGBvsDWM_nrot", nrot))
res <- res[order(res$RYGBvsDWM.Mixed.p),]
res.cols <- c("NGenes", grep("Mixed", colnames(res), value = TRUE))
res <- res[, res.cols]
write.csv(df_signif(res, 3), paste0("RYGBvsDWM_stats_nrot", nrot, "_roast.csv"))
setwd("..")
```

Roast barplot.

```{r roast_barplot, eval=FALSE}
setwd("./results")
#no rownames for ggplot2
pwys <- read.csv("RYGBvsDWM_stats_nrot2e+05_roast.csv")
colnames(pwys) <- sub("RYGBvsDWM.Mixed.", "", colnames(pwys), fixed = TRUE)
colnames(pwys)[1] <- "pwy.nm"
pwys$nlog10pv <- -log10(pwys$p)
pwys.ss <- pwys[pwys$FDR < 0.01,]
pwys.ss$pwy.nm <- factor(pwys.ss$pwy.nm, levels=rev(pwys.ss$pwy.nm), ordered=TRUE)

ggp <- ggplot(data=pwys.ss, mapping=aes(x=pwy.nm, y=nlog10pv, fill=FDR)) + geom_col() + xlab("Pathway") + theme_bw() + 
  ylab("-log10(p-value)") + coord_flip() + theme(legend.title = element_text(size = 16), legend.text = element_text(size = 16),
                                                 axis.title.x=element_text(size=20), axis.text.x=element_text(size=12),
                                                 axis.text.y=element_text(size=24), axis.title.y = element_blank())
# fig will be horizontal in paper
ggsave("../figures/pwy_sig_barplot.pdf", ggp, width=11, height=5)
setwd("..")
```

Plot Roast pwys.

```{r plot_pwys, eval=FALSE}
setwd("./results")

fs <- read.csv("deltadelta_t.csv", row.names = 1)
#net plots
fs.z <- data.frame(z=fs$RYGBvsDWM.t, annot=fs$CHEBI)
rownames(fs.z) <- rownames(fs)
fs.z$annot[is.na(fs.z$annot)] <- rownames(fs.z)[is.na(fs.z$annot)]
new.chebi <- setdiff(names(chebi.map), rownames(fs.z))
new.chebi.df <- data.frame(z=NA, annot=chebi.map[new.chebi])
fs.z <- rbind(fs.z, new.chebi.df)

pwy.tmp <- read.csv("RYGBvsDWM_nrot2e+05_mroast/pathways/Beta_Alanine_Metabolism.csv", row.names = 1)
ntop <- 7
plot_pwy(feat.tab = fs.z, G.pwy = smpdb_gmt[["Beta-Alanine Metabolism"]], stat.colnm = "z", annot.col = "annot",
         gr=gr, ntop = ntop, alternative="two.sided", repel = TRUE, seed=0,
         name = paste0("../figures/Beta_Alanine_Metabolism_ntop", ntop))

# only 4 analytes intersect
pwy.tmp <- read.csv("RYGBvsDWM_nrot2e+05_mroast/pathways/Phospholipid_Biosynthesis.csv", row.names = 1)
ntop <- 7
plot_pwy(feat.tab = fs.z, G.pwy = smpdb_gmt[["Phospholipid Biosynthesis"]], stat.colnm = "z", annot.colnm = "annot",
         gr=gr, ntop = ntop, alternative="two.sided", repel = TRUE, seed=3,
         name = paste0("../figures/Phospholipid_Biosynthesis_ntop", ntop))
setwd("..")
```

# Pame

We apply Hitman to combined (metabolite + protein) dataset, then test Pame.

```{r}
# diff_mat file created in gb_ww_net_integration
diff.mat3 <- read.csv("../slimm-t2d-omics-data/soma_and_met_diff_mat.csv", row.names=1)
```

## Pame homair

```{r deltas.homair}
nms.tmp <- intersect(colnames(diff.mat3), rownames(diff.pheno12)[!is.na(diff.pheno12$homair)])
hm <- hitman(E=as.numeric(diff.pheno12[nms.tmp, "arm"]=="RYGB"), 
             M=diff.mat3[,nms.tmp], 
             Y=diff.pheno12[nms.tmp, "homair"])
hm.df <- data.frame(signif(hm, 3), CHEBI=chebi.map[rownames(hm)])
write.csv(hm.df, "results/homair12_vs_analytes3_hitman_stats.csv")
```

We write the hitman results for each analyte's 3mo change from baseline as a mediator of 12mo HOMA-IR change.

```{r ph.homair, eval=FALSE}
setwd("./results")
hm.df <- read.csv("homair12_vs_analytes3_hitman_stats.csv", row.names = 1)
diff.nms <- intersect(rownames(diff.pheno12)[!is.na(diff.pheno12$homair)], colnames(diff.mat3))
exposure.v <- as.numeric(diff.pheno12[diff.nms, "arm"] == "RYGB")

nperm <- 5*10**4
nm <- paste0("homair_stats_nperm", nperm)
c(ps, fs) %<-% pame(M=diff.mat3[,diff.nms], E=exposure.v, Y=diff.pheno12[diff.nms, "homair"],
                     Gmat=smpdb_gmat, nperm=nperm, min.nfeats=3, 
                     annot.df = hm.df[, c("EMY.p", "EMY.FDR", "CHEBI")], ncores=1, name = nm)
write.csv(ps, paste0(nm, ".csv"))

# feature stats from Pants non-parametric permutations
feat.df <- data.frame(ezlimma::df_signif(fs, 3), annot=chebi.map[rownames(fs)])
write.csv(feat.df, paste0("homair_feature_stats_nperm", nperm, "_pame.csv"))
setwd("..")
```

## Pame HbA1c

```{r deltas.HbA1c}
setwd("./results", eval=FALSE)
nms.tmp <- intersect(colnames(diff.mat3), rownames(diff.pheno12)[!is.na(diff.pheno12$HbA1c)])
hm <- hitman(E=as.numeric(diff.pheno12[nms.tmp, "arm"]=="RYGB"), 
             M=diff.mat3[,nms.tmp], 
             Y=diff.pheno12[nms.tmp, "HbA1c"])
hm.df <- data.frame(signif(hm, 3), CHEBI=chebi.map[rownames(hm)])

diff.nms <- intersect(rownames(diff.pheno12)[!is.na(diff.pheno12$HbA1c)], colnames(diff.mat3))
exposure.v <- as.numeric(diff.pheno12[diff.nms, "arm"] == "RYGB")

nperm <- 10**4
nm <- paste0("HbA1c_stats_nperm", nperm)
begin <- Sys.time()
c(ps, fs) %<-% pame(M=diff.mat3[,diff.nms], E=exposure.v, Y=diff.pheno12[diff.nms, "HbA1c"],
                     Gmat=smpdb_gmat, nperm=nperm, min.nfeats=3, 
                     annot.df = hm.df[, c("EMY.p", "EMY.FDR", "CHEBI")], ncores=1, name = nm)
end <- Sys.time()
(end - begin)/nperm # 0.00064 mins

head(ps) # min fdr = 0.36

setwd("..")
```

We find no significant pathways.

## Pame dins030

```{r deltas.dins030, eval=FALSE}
setwd("./results")
nms.tmp <- intersect(colnames(diff.mat3), rownames(diff.pheno12)[!is.na(diff.pheno12$dins030)])
hm <- hitman(E=as.numeric(diff.pheno12[nms.tmp, "arm"]=="RYGB"), 
             M=diff.mat3[,nms.tmp], 
             Y=diff.pheno12[nms.tmp, "dins030"])
hm.df <- data.frame(signif(hm, 3), CHEBI=chebi.map[rownames(hm)])

diff.nms <- intersect(rownames(diff.pheno12)[!is.na(diff.pheno12$dins030)], colnames(diff.mat3))
exposure.v <- as.numeric(diff.pheno12[diff.nms, "arm"] == "RYGB")

nperm <- 10**4
nm <- paste0("dins030_stats_nperm", nperm)
c(ps, fs) %<-% pame(M=diff.mat3[,diff.nms], E=exposure.v, Y=diff.pheno12[diff.nms, "dins030"],
                     Gmat=smpdb_gmat, nperm=nperm, min.nfeats=3, 
                     annot.df = hm.df[, c("EMY.p", "EMY.FDR", "CHEBI")], ncores=1, name = nm)
head(ps) # min  FDR 0.21
setwd("..")
```

We find no signifiance pathways.

# Session info

```{r sessioninfo, include=TRUE}
devtools::session_info()
```

```{r check}
# Test expectations
stopifnot("HbA1c" %in% colnames(pheno))
stopifnot(pheno[grep("_0", rownames(pheno)), "dmcure"]==0)
stopifnot(diff.pheno["RADIO_3", "HbA1c"] == pheno["RADIO_3", "HbA1c"]-pheno["RADIO_0", "HbA1c"])
stopifnot(colnames(soma.mat) %in% rownames(pheno))
stopifnot(diff.pheno["RADIO_3", "HbA1c"] == pheno["RADIO_3", "HbA1c"] - pheno["RADIO_0", "HbA1c"])
#check match to soma_and_met_diff_mat.csv
stopifnot(abs(diff.soma.mat["SL000252", "BLUSH_3"] - -0.232048936) < 10**-6)
#from causal plot
dm <- diff.soma.mat["SL006694", grep("_3$", colnames(diff.soma.mat))]
stopifnot(dm < 0.5, dm > -2)
stopifnot(soma.annot["SL005168", "EntrezGeneSymbol"]=="GHR", 
          soma.annot["SL006694", "EntrezGeneSymbol"]=="CNDP1",
          met.annot["C1806", "BIOCHEMICAL"]=="retinol (Vitamin A)",
          met.annot["C34407", "BIOCHEMICAL"]=="isovalerylcarnitine")
stopifnot(paste0(rownames(diff.pheno12), "_3") %in% colnames(diff.soma.mat))
stopifnot(paste0(rownames(diff.pheno12), "_3") %in% rownames(diff.pheno))

stopifnot("HbA1c" %in% colnames(pheno))
stopifnot(diff.pheno["RADIO_3", "HbA1c"] == pheno["RADIO_3", "HbA1c"]-pheno["RADIO_0", "HbA1c"])

stopifnot(colnames(soma.mat) %in% rownames(pheno))

stopifnot(diff.pheno["RADIO_3", "HbA1c"] == pheno["RADIO_3", "HbA1c"] - pheno["RADIO_0", "HbA1c"])
#one rbp4 diff (for VENUE) is >60; others [-20, 20]
# stopifnot(diff.rbp4.ttr["RBP4", "IMAGE_3"] == rbp4.ttr["RBP4", "IMAGE_3"] - rbp4.ttr["RBP4", "IMAGE_0"])
#check match to gb_ww_net_integration/soma_and_met_diff_mat.csv
stopifnot(abs(diff.soma.mat["SL000252", "BLUSH_3"] - -0.232048936) < 10**-6)

# stopifnot(rownames(diff.pheno12)==rownames(diff.pheno12.hm))

#from causal plot
dm <- diff.soma.mat["SL006694", grep("_3$", colnames(diff.soma.mat))]
stopifnot(dm < 0.5, dm > -2)

stopifnot(soma.annot["SL005168", "EntrezGeneSymbol"]=="GHR", 
          soma.annot["SL006694", "EntrezGeneSymbol"]=="CNDP1",
          met.annot["C1806", "BIOCHEMICAL"]=="retinol (Vitamin A)",
          met.annot["C34407", "BIOCHEMICAL"]=="isovalerylcarnitine")

stopifnot(paste0(rownames(diff.pheno12), "_3") %in% colnames(diff.soma.mat))
stopifnot(paste0(rownames(diff.pheno12), "_3") %in% rownames(diff.pheno))

stopifnot(sum(smpdb_gmat["CHEBI:37373",]) == 1)
stopifnot("CHEBI:37373" %in% rownames(diff.mat3))

# cor soma vs met
stopifnot(order(-abs(as.numeric(cor.array[,,"r"]))) == order(as.numeric(cor.array[,, "p"])))
stopifnot(cor.r["OMD", "pro-hydroxy-pro"] == 0.521)
# signif(cor.array[,,"p"][wm], 3)
stopifnot(ncol(cor.r) == 62)
wm <- which.min(abs(cor.array[,,"p"]-0.05))
stopifnot(signif(abs(cor.array[,,"r"][wm]), 2) == 0.33)
stopifnot(signif(cor.array[,,"FDR"][wm], 2) == 0.24)
```