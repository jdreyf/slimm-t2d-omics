---
title: Analyze omics from SLIMM-T2D trial
author: "jd"
date: "`r Sys.Date()`"
output: word_document
---

## Install & load R packages

Install related R packages from GitHub, if needed. This is also described in the `ezlimmaplot` README at [https://github.com/jdreyf/ezlimmaplot](https://github.com/jdreyf/ezlimmaplot). Other packages can be installed with `install.packages()`.

```{r, eval=FALSE, include=FALSE}
#if haven't already installed limma
install.packages("BiocManager") #if haven't already installed BiocManager
library(BiocManager)
BiocManager::install("limma")

library(remotes)
remotes::install_github(repo="jdreyf/ezlimma", build_opts = c("--no-resave-data", "--no-manual"), build_vignettes = TRUE)
remotes::install_github(repo="jdreyf/ezlimmaplot", build_opts = c("--no-resave-data", "--no-manual"), build_vignettes = TRUE)
remotes::install_github(repo="jdreyf/Hitman", build_opts = c("--no-resave-data", "--no-manual"), build_vignettes = TRUE)
```

Load and attached the above and other R packages.

```{r setup, include=FALSE}
setwd("B:/patti/gb_ww_trial/slimm-t2d-omics/")

knitr::opts_chunk$set(echo = FALSE, include=FALSE)
options(digits=3, stringsAsFactors=FALSE)
source("R/make_diff_mat.R")

library(dplyr)
library(usethis)
library(ggplot2)
library(knitr)
library(Matrix)
library(zeallot)

library(limma)
library(ezlimma)
library(ezlimmaplot)
library(Hitman)

FDR <- 0.15
FC <- 1.5
```

# Read data and take the difference from baseline per person

Clinical metadata at [clin_metadata.csv](./data/clin_metadata.csv). This file also used for uploads to GEO. Here, change colnames in workflow, so can use them more easily in ggplot2. After taking differences of phenotypes, we remove individual points from R object *diff.pheno*, such as Topaz_3, who have NA in every measure.

The original SOMAscan dataset was parsed to write [soma_annot.csv](./data/soma_annot.csv) and log2-transformed to write [soma_mat.csv](./data/soma_mat.csv).

The original metabolomics dataset was parsed, filtered, and log2-transformed to write [met_mat_norm.csv](./data/met_mat_norm.csv). Annotations for metabolites did not originally have CHEBI annotations, but these were needed for Pathaway analysis via network-smoothing to match our network (Pathway Commons PC9) and pathway database (SMPDB), so we added these automatically using CTSgetR. However, CTSgetR wasn't given the chirality of many compounds, so we found that 3-hydroxyisobutyrate had CHEBI:11805, whereas SMPDB had (S)-3-Hydroxyisobutyric acid (CHEBI:37373), so we manually fixed 3-hydroxyisobutyrate to have CHEBI:37373, and wrote  [met_annot_with_chebi.csv](./data/met_annot_with_chebi.csv).

```{r read}
pheno <- read.csv("data/clin_metadata.csv", row.names = 1, check.names = FALSE)
clin.names.map <- data.frame(full_name=colnames(pheno))
#make colnames easier to use in ggplot2, but keep a mapping to long names
colnames(pheno) <- sub("Group", "arm", 
                       gsub(" ", "_", 
                            gsub(":.+| \\(.+", "", colnames(pheno))))
rownames(clin.names.map) <- clin.names.map$abbrev <- colnames(pheno)
pheno$grp <- paste(pheno$arm, pheno$Mo, sep="_")

soma.mat <- read.csv("data/soma_mat.csv", row.names=1)
diff.soma.mat <- make_diff_mat(soma.mat)
soma.annot <- read.csv("data/soma_annot.csv", row.names = 1)

met.mat <- read.csv("data/met_mat_norm.csv", row.names=1)
diff.met.mat <- make_diff_mat(met.mat)
met.annot <- read.csv("data/met_annot_with_chebi.csv", row.names = 1)
```

```{r grp}
mo.v <- c(0, 3, 12, 24, 36)
contr.v1 <- paste0('RYGB_', mo.v, '-DWM_', mo.v)
names(contr.v1) <- paste0('RYGBvsDWMat', mo.v, 'mo')

avg.grps <- paste0(rep(c("DWM", "RYGB"), each=length(mo.v)), "_", mo.v, ".avg")
grp <- setNames(pheno$grp, nm=rownames(pheno))
```

Samples in 12mo metabolomics and proteomics are identical, so create diff_mats at 1 year. Also, create a combined annotation.

```{r dan12}
dsoma12 <- diff.soma.mat[,grep("_12$", colnames(diff.soma.mat))]
dmet12 <- diff.met.mat[,grep("_12$", colnames(diff.met.mat))]
```

Calculate metadata differences from baseline and remove samples with too many NAs, who shouldn't be used in Hitman.

```{r diff.pheno}
diff.pheno <- t(make_diff_mat(t(pheno[,setdiff(colnames(pheno), c('Acrostic', 'arm', 'Height', 'Mo', 'grp'))])))
# dmcure has NA as 9 and is a computed column, so doesn't need to be tested in na.row
na.rows <- which(rowMeans(is.na(diff.pheno[,setdiff(colnames(diff.pheno), c("month", "dmcure"))])) == 1)
diff.pheno <- diff.pheno[-na.rows,]
diff.pheno <- data.frame(diff.pheno, arm=pheno[rownames(diff.pheno), c("arm")], grp=pheno[rownames(diff.pheno), c("grp")],
                         check.names = FALSE)
diff.pheno3 <- diff.pheno[grep("_3$", rownames(diff.pheno)),]
diff.pheno12 <- diff.pheno[grep("_12$", rownames(diff.pheno)),]
rownames(diff.pheno12) <- gsub("_12$", "", rownames(diff.pheno12))
```

# Differential abundance between groups

Analyze differences between groups at each time point, and these differences after taking each person's difference from baseline, with and without adjusting for each person's change in BMI.

```{r des.bmi}
des.diff.bmi <- model.matrix(object = ~0+grp+BMI, data=diff.pheno)
colnames(des.diff.bmi) <- sub("grp", "", colnames(des.diff.bmi), fixed=TRUE)
des.diff.bmi <- des.diff.bmi[,setdiff(colnames(des.diff.bmi), c("DWM_18", "RYGB_18"))]

contr.bmi <- contr.v1[-1]
names(contr.bmi) <- paste0(names(contr.bmi), "_bmi")
```

## Proteome

```{r soma ezl}
#for means, use initial mat
soma.stats <- limma_contrasts(soma.mat, grp=grp[colnames(soma.mat)], contr.v1)
#order avg cols
avg.cols <- intersect(avg.grps, grep("avg$", colnames(soma.stats), value = TRUE))
t0.cols <- grep("^RYGBvsDWMat0mo", colnames(soma.stats), value = TRUE)

soma.diff.stats <- limma_contrasts(diff.soma.mat, grp=grp[colnames(diff.soma.mat)], contr=contr.v1[-1], add.means = FALSE)
soma.bmi.diff.stats <- limma_contrasts(diff.soma.mat, design = des.diff.bmi[colnames(diff.soma.mat),], 
                                              contr=contr.bmi, add.means = FALSE)

soma.tab <- data.frame(soma.stats[rownames(soma.diff.stats), c(avg.cols, t0.cols)], soma.diff.stats, 
                       soma.bmi.diff.stats[rownames(soma.diff.stats),], soma.annot[rownames(soma.diff.stats),])
write.csv(df_signif(soma.tab), "results/soma_supp_table.csv")
```

The Soma supp table with means per group per time point and statistics on differences between groups on differences from baseline is at [soma_supp_table.csv](./results/soma_supp_table.csv). 

```{r soma_venns}
setwd("./results")
soma.venn <- ezvenn(soma.tab, prefix.v = c(names(contr.v1)[-1], names(contr.bmi)), fdr.cutoff = FDR, 
                    name=paste0("soma_FDR", 100*FDR), plot = FALSE)
soma.sig <- rownames(soma.venn)[rowSums(abs(soma.venn)) > 0]
soma.sig.nobmi <- rownames(soma.venn)[rowSums(abs(soma.venn[, paste0(names(contr.v1)[-1], ".sig") ])) > 0]
soma.venn.df <- data.frame(soma.venn[soma.sig,], soma.annot[soma.sig, 1:7])
write.csv(soma.venn.df, paste0("soma_FDR", 100*FDR, "_venn.csv"))

soma.venn.ss <- soma.venn.df %>% filter(RYGBvsDWMat3mo.sig != 0 & RYGBvsDWMat3mo_bmi.sig != 0) %>%
  select(RYGBvsDWMat3mo.sig, RYGBvsDWMat3mo_bmi.sig, EntrezGeneSymbol, TargetFullName)

setwd("..")
```

The Venn table using FDR but not logFC is `r paste0("soma_FDR", 100*FDR, "_venn.csv")`.

```{r soma.heat}
setwd("./figures")
soma.venn.lfc <- ezvenn(soma.tab, prefix.v = c(names(contr.v1)[-1], names(contr.bmi)), fdr.cutoff = FDR,
                        logfc.cutoff = log2(FC), name=paste0("soma_FDR", 100*FDR), plot = FALSE)
soma.sig.lfc.nobmi <- rownames(soma.venn.lfc)[rowSums(abs(soma.venn.lfc[, paste0(names(contr.v1)[-1], ".sig") ])) > 0]

heat.mat <- data.matrix(soma.stats[soma.sig.lfc.nobmi, grep("logFC$", colnames(soma.stats))])
labRow <- sub(";.+", "", soma.annot[rownames(heat.mat), "EntrezGeneSymbol"])
labCol <- gsub("RYGBvsDWMat|mo\\.logFC", "", colnames(heat.mat))
ezheat(object=heat.mat, labrows = labRow,  name="soma_FDR15_fc50pct_heat", sc="none", labcols = labCol, clip=log2(3), 
       reorder_rows = TRUE, reorder_cols = FALSE, fontsize_row = 8, fontsize_col = 16, angle_col = "0")
heat.df <- data.frame(signif(heat.mat, 3), soma.annot[rownames(heat.mat),])
write.csv(heat.df, "../results/soma_heat.csv")
setwd("..")
```

The heatmap w/ `r nrow(heat.df)` analytes is at [soma_FDR15_fc50pct_heat.pdf](./results/soma_FDR15_fc50pct_heat.pdf). 

### Text

We summarize that the number of proteins significant at FDR `r FDR`:  
* At baseline: `r sum(soma.tab$RYGBvsDWMat0mo.FDR < FDR)`  
* At 3 mo in unadj: `r sum(soma.tab$RYGBvsDWMat3mo.FDR < FDR)`; whereas in adj: `r sum(soma.tab$RYGBvsDWMat3mo_bmi.FDR < FDR)`. In both, not inc. lfc, we have `r knitr::kable(soma.venn.ss)`  
* After baseline correction, there are `r length(soma.sig.nobmi)` proteins that are significant at any time point without BMI adjustment. Of these, `r length(soma.sig.lfc.nobmi)` have sufficient FC to be in the heatmap.

## Metabolome

```{r met ezl}
#mets don't have 24mo time
met.stats <- limma_contrasts(met.mat, grp=grp[colnames(met.mat)], contr.v1[-4])
met.diff.stats <- limma_contrasts(diff.met.mat, grp=grp[colnames(diff.met.mat)], contr=contr.v1[-c(1, 4)], add.means = FALSE)
des.met.diff.bmi <- des.diff.bmi[,setdiff(colnames(des.diff.bmi), c("DWM_24", "RYGB_24"))]
met.bmi.diff.stats <- signif(limma_contrasts(diff.met.mat, design = des.met.diff.bmi[colnames(diff.met.mat),], 
                                              contr=contr.bmi[-3], add.means = FALSE), 3)
#order avg cols
avg.cols <- intersect(avg.grps, grep("avg$", colnames(met.stats), value = TRUE))
t0.cols <- grep("^RYGBvsDWMat0mo", colnames(met.stats), value = TRUE)

met.tab <- data.frame(met.stats[rownames(met.diff.stats), c(avg.cols, t0.cols)], met.diff.stats, 
                      met.bmi.diff.stats[rownames(met.diff.stats),], met.annot[rownames(met.diff.stats),])
write.csv(df_signif(met.tab), "./results/met_supp_table.csv", na="")
```

Analyze differences between groups at each time point, and these differences after taking each person's difference from baseline. The met supp table with means per group per time point and statistics on differences between groups on differences from baseline is at [met_supp_table.csv](./results/met_supp_table.csv).

```{r met_venns}
setwd("./results")
met.venn <- ezvenn(met.tab, prefix.v = c(names(contr.v1)[-c(1, 4)], names(contr.bmi)[-3]), fdr.cutoff = FDR, 
                   logfc.cutoff = log2(FC), name=paste0("met_FDR", 100*FDR), plot = FALSE)
met.venn <- met.venn[rowSums(abs(met.venn)) > 0,]
met.sig <- rownames(met.venn)
met.sig.nobmi <- rownames(met.venn)[rowSums(abs(met.venn[, paste0(names(contr.v1)[-c(1, 4)], ".sig") ])) > 0]
met.venn.df <- data.frame(met.venn[met.sig,], met.annot[met.sig,])
write.csv(met.venn.df, "met_FDR15_venn.csv")

met.venn.ss <- met.venn.df %>% filter(RYGBvsDWMat3mo.sig != 0 & RYGBvsDWMat3mo_bmi.sig != 0) %>%
  select(RYGBvsDWMat3mo.sig, RYGBvsDWMat3mo_bmi.sig, BIOCHEMICAL)

setwd("..")
```

The Venn table using FDR but not logFC is `r paste0("met_FDR", 100*FDR, "_venn.csv")`.

```{r met.heat}
setwd("./figures")
met.venn.lfc <- ezvenn(met.tab, prefix.v = c(names(contr.v1)[-c(1, 4)], names(contr.bmi)[-3]), fdr.cutoff = FDR,
                        logfc.cutoff = log2(FC), name=paste0("met_FDR", 100*FDR), plot = FALSE)
met.sig.lfc.nobmi <- rownames(met.venn.lfc)[rowSums(abs(met.venn.lfc[, paste0(names(contr.v1)[-c(1, 4)], ".sig") ])) > 0]

heat.mat <- data.matrix(met.stats[met.sig.lfc.nobmi, grep("logFC$", colnames(met.stats))])
# rm "*" or "(1)" or "(2)" at end of name
labRow <- sub(" \\([1-2]\\)$|\\*$", "", met.annot[rownames(heat.mat), "BIOCHEMICAL"])
labCol <- gsub("RYGBvsDWMat|mo\\.logFC", "", colnames(heat.mat))
ezheat(heat.mat, labrows = labRow,  name="met_FDR15_fc50pct_heat", sc="none", labcols = labCol, clip=log2(3),
       reorder_rows = TRUE, reorder_cols = FALSE, fontsize_row = 6, fontsize_col = 16, angle_col = "0")
heat.df <- data.frame(signif(heat.mat, 3), met.annot[rownames(heat.mat),])
write.csv(heat.df, "../results/met_heat.csv")
setwd("..")
```

The heatmap w/ `r nrow(heat.df)` analytes is at [met_FDR15_fc50pct_heat.pdf](./results/met_FDR15_fc50pct_heat.pdf).

### Text

We summarize that the number of proteins significant at FDR `r FDR`:  
* At baseline: `r sum(met.tab$RYGBvsDWMat0mo.FDR < FDR)`  
* At 3 mo in unadj: `r sum(met.tab$RYGBvsDWMat3mo.FDR < FDR)`; whereas in adj: `r sum(met.tab$RYGBvsDWMat3mo_bmi.FDR < FDR)`. In both, not inc. log fold-change threshold, we have `r nrow(met.venn.ss)` metabolites.  
* 3-hydroxyisobutyrate at 3mo: `r knitr::kable(met.venn.lfc["C1549", c("RYGBvsDWMat3mo_bmi.sig", "RYGBvsDWMat3mo.sig")])`  
* After baseline correction, there are `r length(met.sig.nobmi)` proteins that are significant at any time point without BMI adjustment. Of these, `r length(met.sig.lfc.nobmi)` have sufficient FC to be in the heatmap.


# Correlate soma vs. met


We correlate top somalogic proteins with top metabolites. There are duplicate probes for one protein, so we remove the duplicated probe and only have one row for that protein.

```{r corsm}
nms.tmp <- intersect(grep("_3$", colnames(diff.soma.mat), value=TRUE),
                     grep("_3$", colnames(diff.met.mat), value=TRUE))

mv <- read.csv("results/met_heat.csv", row.names = 1)
top.met <- rownames(mv)[order(met.annot[rownames(mv), "BIOCHEMICAL"])]
sv <- read.csv("results/soma_heat.csv", row.names = 1)
top.soma <- rownames(sv)[order(soma.annot[rownames(sv), "EntrezGeneSymbol"])]

diff.soma.mat3.ss <- data.matrix(diff.soma.mat[top.soma, nms.tmp])
rownames(diff.soma.mat3.ss) <- soma.annot[rownames(diff.soma.mat3.ss), "EntrezGeneSymbol"]
diff.soma.mat3.ss <- diff.soma.mat3.ss[!duplicated(rownames(diff.soma.mat3.ss)),]

diff.met.mat3.ss <- data.matrix(diff.met.mat[top.met, nms.tmp])
rownames(diff.met.mat3.ss) <- met.annot[rownames(diff.met.mat3.ss), "BIOCHEMICAL"]
```

```{r build_corr_mat}
dimnms <- list(rownames(diff.soma.mat3.ss), rownames(diff.met.mat3.ss), c("r", "p", "FDR"))
cor.array <- array(data=NA, dim = sapply(dimnms, length), dimnames=dimnms)
for (soma.row in rownames(diff.soma.mat3.ss)){
  for (met.row in rownames(diff.met.mat3.ss)){
    ct <- cor.test(x=diff.soma.mat3.ss[soma.row,], y=diff.met.mat3.ss[met.row,])
    cor.array[soma.row, met.row, "r"] <- ct$estimate
    cor.array[soma.row, met.row, "p"] <- ct$p.value
  }
}
cor.array[,, "FDR"] <- p.adjust(cor.array[,, "p"], method = "BH")

cor.r <- signif(cor.array[,,"r"], 3)
cor.r.out <- cbind(cor.r, "---"=NA, NA)

wm <- which.min(abs(cor.array[,,"p"]-0.05))
r.p.05 <- signif(abs(cor.array[,,"r"][wm]), 2)
q.p.05 <- signif(cor.array[,,"FDR"][wm], 2)
cor.r.colnm <- paste0("NOTE: p=0.05 corresponds to |r|=", r.p.05, " & FDR=", q.p.05)
colnames(cor.r.out)[ncol(cor.r.out)] <- cor.r.colnm

# colnames(cor.r.out)[(ncol(cor.r.out)-1)] <- NA
write.csv(t(cor.r.out), "results/soma_met_corr_coeffs.csv", na = "")
```


# Hitman


We apply Hitman to 12mo outcome change from baseline using change at 3mo from baseline as mediators and arm as exposure. The results of these mediation tests are written as CSVs to [results](./results/) folder using the naming convention outcome-timepoint_vs_mediator-timepoint_hitman, such as "HbA1c12_vs_soma3_hitman.csv," whose *EMY* columns hold the overall p-values and FDRs, and corresponding chi-squared on 1 degree of freedom, where larger is more significant.

## HbA1c

We apply Hitman to 12mo HbA1c change using change at 3mo from baseline in analytes and clinical parameters as mediators.

```{r hm_a1c_3}
#soma
nms.tmp <- intersect(gsub("_3$", "", grep("_3$", colnames(diff.soma.mat), value=TRUE)), rownames(diff.pheno12))
hm.a1c.soma <- hitman(E=as.numeric(diff.pheno12[nms.tmp, "arm"]=="RYGB"), 
                  M=diff.soma.mat[,paste0(nms.tmp, "_3")], 
                  Y=diff.pheno12[nms.tmp, "HbA1c"])
hm.a1c.soma.df <- data.frame(signif(hm.a1c.soma, 3), soma.annot[rownames(hm.a1c.soma),])
write.csv(hm.a1c.soma.df, "./results/HbA1c12_vs_soma3_hitman.csv")
#met
nms.tmp <- intersect(gsub("_3$", "", grep("_3$", colnames(diff.met.mat), value=TRUE)), rownames(diff.pheno12))
hm.a1c.met <- hitman(E=as.numeric(diff.pheno12[nms.tmp, "arm"]=="RYGB"), M=diff.met.mat[,paste0(nms.tmp, "_3")], 
                  Y=diff.pheno12[nms.tmp, "HbA1c"])
hm.a1c.met.df <- data.frame(signif(hm.a1c.met, 3), met.annot[rownames(hm.a1c.met),])
write.csv(hm.a1c.met.df, "./results/HbA1c12_vs_met3_hitman.csv")

#clinical
#remove: arm & grp not a difference; creatinine not measured at 3mo
rm.cols <- c("arm", "grp", grep("Creatinine", colnames(diff.pheno3), value=TRUE))
diff.pheno3 <- diff.pheno3[,setdiff(colnames(diff.pheno3), rm.cols)]
rownames(diff.pheno3) <- gsub("_3$", "", rownames(diff.pheno3))
diff.pheno3 <- diff.pheno3[intersect(rownames(diff.pheno3), rownames(diff.pheno12)),]
#diff.pheno3 has TOPAZ, but TOPAZ has all NAs at 12mo
arm.v <- setNames(as.numeric(pheno[paste0(rownames(diff.pheno3), "_0"), "arm"]=="RYGB"), nm=rownames(diff.pheno3))
HbA1c <- setNames(diff.pheno12[rownames(diff.pheno3), "HbA1c"], nm=rownames(diff.pheno3))

# ezmediate gives p=0, which is not correct, even with 10**4 simulations
clin3.hm <- Hitman:::hitman(E=arm.v, M=t(diff.pheno3), Y=HbA1c)
write.csv(signif(clin3.hm, 3), "./results/HbA1c12_vs_clin3_hitman.csv", na="")
```

### Compare clinical vs analytes

```{r}
hm.a1c.soma.df.ss <- hm.a1c.soma.df[hm.a1c.soma.df$EMY.p < clin3.hm[1, "EMY.p"] & 
                                      hm.a1c.soma.df$EMY.FDR < clin3.hm[1, "EMY.FDR"],]
pr <- rownames(hm.a1c.soma.df.ss)
hm.soma.top <- data.frame(probe=pr, ratio3=fc2ratio(soma.stats[pr, "RYGBvsDWMat3mo.FC"]),
                          nm=hm.a1c.soma.df.ss$TargetFullName, 
                          EntrezGeneSymbol=hm.a1c.soma.df.ss$EntrezGeneSymbol)

hm.a1c.met.df.ss <- hm.a1c.met.df[hm.a1c.met.df$EMY.p < clin3.hm[1, "EMY.p"] & 
                                      hm.a1c.met.df$EMY.FDR < clin3.hm[1, "EMY.FDR"],]
```

The protein analytes more significant in p-value & FDR than any clinical mediator are: `r kable(hm.soma.top)`

The metabolite mediators are `r hm.a1c.met.df.ss$BIOCHEMICAL`

### Compare Hitman to joint significance

```{r hm_a1c_3_js}
#soma
nms.tmp <- intersect(gsub("_3$", "", grep("_3$", colnames(diff.soma.mat), value=TRUE)), rownames(diff.pheno12))

js.soma <- apply(data.matrix(diff.soma.mat[, paste0(nms.tmp, "_3")]), MARGIN = 1, FUN=function(M){
  tmp <- Hitman:::joint_signif_mediation(E=as.numeric(diff.pheno12[nms.tmp, "arm"]=="RYGB"), 
                                           M=as.numeric(M), Y=diff.pheno12[nms.tmp, "HbA1c"])
  
})
js.a1c.soma.df <- data.frame(EMY.p=signif(js.soma, 3), EMY.FDR=p.adjust(js.soma, method = "fdr"), soma.annot[rownames(diff.soma.mat),])
write.csv(js.a1c.soma.df, "./results/HbA1c12_vs_soma3_jointsignif.csv")
#met
nms.tmp <- intersect(gsub("_3$", "", grep("_3$", colnames(diff.met.mat), value=TRUE)), rownames(diff.pheno12))
js.met <- apply(data.matrix(diff.met.mat[, paste0(nms.tmp, "_3")]), MARGIN = 1, FUN=function(M){
  tmp <- Hitman:::joint_signif_mediation(E=as.numeric(diff.pheno12[nms.tmp, "arm"]=="RYGB"), 
                                           M=as.numeric(M), Y=diff.pheno12[nms.tmp, "HbA1c"])
  
})
js.a1c.met.df <- data.frame(EMY.p=signif(js.met, 3), EMY.FDR=p.adjust(js.met, method = "fdr"), met.annot[rownames(diff.met.mat),])
write.csv(js.a1c.met.df, "./results/HbA1c12_vs_met3_jointsignif.csv")
```

Top analytes: GHR has FDR `r signif(js.a1c.soma.df["SL005168", "EMY.FDR"], 2)` & pro-hydroxy-pro has FDR `r signif(js.a1c.met.df["C35127", "EMY.FDR"], 2)`.

### Plot inconsistent mediation fig
We combine several mediation plotsinto the Hitman figure using `ggplot2 facet_wrap`. We modify this figure by copy-pasting pieces into PPT, then adding text boxes for Inconsistent and Consistent mediators.

```{r hm.fig}
# use facet to combine
# need to coerce to vector with as.numeric
ghr <- as.numeric(diff.soma.mat["SL005168", paste0(rownames(diff.pheno12), "_3")])

met.cols <- intersect(paste0(rownames(diff.pheno12), "_3"), colnames(diff.met.mat))
pheno.cols <- sub("_3$", "", met.cols)
ret <- as.numeric(diff.met.mat["C1806", met.cols])
# php <- as.numeric(diff.met.mat["C35127", met.cols])
php <- as.numeric(diff.met.mat["C35127", met.cols])

hm.df <- rbind(data.frame(x=ghr, a1c=diff.pheno12[,"HbA1c"], Arm=diff.pheno12[,"arm"], an="GHR"),
               data.frame(x=ret, a1c=diff.pheno12[pheno.cols, "HbA1c"], Arm=diff.pheno12[pheno.cols, "arm"], an="Retinol"),
               data.frame(x=php, a1c=diff.pheno12[pheno.cols, "HbA1c"], Arm=diff.pheno12[pheno.cols, "arm"], an="Pro-hydroxy-Pro"))

hm.df$an <- factor(hm.df$an, levels=c('Retinol', 'GHR', 'Pro-hydroxy-Pro'), ordered=TRUE)
ggp <- ggplot(data=hm.df, mapping = aes(x=x, y=a1c, color=Arm)) + facet_wrap(facets="~an", nrow=1, scales="free_x") + geom_point(alpha=0.7) + 
  geom_smooth(method="lm", se=FALSE) + xlab(paste("Log2 abundance change (3 mo)")) + ylab("HbA1c change (1 yr)") + theme_bw() +
  theme(text=element_text(size=7)) + theme(axis.text.x=element_text(size=5)) + scale_colour_manual(values=c("blue", "red"))
ggsave(file="figures/hitman_figure.pdf", plot=ggp, height=2)
```

## HOMA-IR

We apply Hitman to 12mo HOMA-IR change using 3mo analyte change as mediators.

```{r hm_homair_3}
#soma
nms.tmp <- intersect(gsub("_3$", "", grep("_3$", colnames(diff.soma.mat), value=TRUE)),
                     rownames(diff.pheno12)[!is.na(diff.pheno12$homair)])
hm.homair.soma <- hitman(E=as.numeric(diff.pheno12[nms.tmp, "arm"]=="DWM"), 
                  M=diff.soma.mat[,paste0(nms.tmp, "_3")], 
                  Y=diff.pheno12[nms.tmp, "homair"])
hm.soma.df <- data.frame(signif(hm.homair.soma, 3), soma.annot[rownames(hm.homair.soma),])
write.csv(hm.soma.df, paste0("./results/homair12_vs_soma3_hitman.csv"))
#met
nms.tmp <- intersect(gsub("_3$", "", grep("_3$", colnames(diff.met.mat), value=TRUE)),
                     rownames(diff.pheno12)[!is.na(diff.pheno12$homair)])
hm.homair.met <- hitman(E=as.numeric(diff.pheno12[nms.tmp, "arm"]=="DWM"), M=diff.met.mat[,paste0(nms.tmp, "_3")], 
                  Y=diff.pheno12[nms.tmp, "homair"])
hm.met.df <- data.frame(signif(hm.homair.met, 3), met.annot[rownames(hm.homair.met),])
write.csv(hm.met.df, paste0("./results/homair12_vs_met3_hitman.csv"))
```

## dins030

We apply Hitman to dins030 [change in insulin from 0 to 30 min in mixed-meal tolerance test (mcU/ml)] change at 12mo from baseline using 3mo analyte change from baseline as mediators.

```{r hm_dins030_3}
#soma
nms.tmp <- intersect(gsub("_3$", "", grep("_3$", colnames(diff.soma.mat), value=TRUE)),
                     rownames(diff.pheno12)[!is.na(diff.pheno12$dins030)])
hm.dins.soma <- hitman(E=as.numeric(diff.pheno12[nms.tmp, "arm"]=="DWM"), 
                  M=diff.soma.mat[,paste0(nms.tmp, "_3")], 
                  Y=diff.pheno12[nms.tmp, "dins030"])
hm.soma.df <- data.frame(signif(hm.dins.soma, 3), soma.annot[rownames(hm.dins.soma),])
write.csv(hm.soma.df, paste0("./results/dins030_12_vs_soma3_hitman.csv"))
#met
nms.tmp <- intersect(gsub("_3$", "", grep("_3$", colnames(diff.met.mat), value=TRUE)),
                     rownames(diff.pheno12)[!is.na(diff.pheno12$dins030)])
hm.dins.met <- hitman(E=as.numeric(diff.pheno12[nms.tmp, "arm"]=="DWM"), M=diff.met.mat[,paste0(nms.tmp, "_3")], 
                  Y=diff.pheno12[nms.tmp, "dins030"])
hm.met.df <- data.frame(signif(hm.dins.met, 3), met.annot[rownames(hm.dins.met),])
write.csv(hm.met.df, paste0("./results/dins030_12_vs_met3_hitman.csv"))
```


# Pathways


For pathway input data, differences from baseline are combined for people who have both somascan & metabolomics. Analytes are subset and summarized (by averaging over analytes with the same ID) to match network, for network plotting.

We plot the top pathways. The t-statistics from ezlimma have sufficiently many degrees of freedom to be approximately z-scores, which are better known, so we annotate them as z-scores. For a network plotting of differences, we use Pathway Commons PC9 and SMPDB files downloaded around 2016.

```{r net_data}
load("data/pc9.rda")
gr <- igraph::simplify(igraph::graph_from_edgelist(pc9, directed = FALSE))
load("data/smpdb_gmat.rda")
# smpdb_gmat <- smpdb_gmat[setdiff(rownames(smpdb_gmat), "CHEBI:15377"),]
smpdb_gmt <- gmat2gmt(smpdb_gmat)
```

We map ChEBI IDs in PC9 to chemical names, so that we can show the names in our network plots.

```{r chebi_map}
# file created in gb_ww_net_integration
chebi.map <- read.csv('data/chebi_map_v2.csv', row.names=1)
#turn into a named vector
chebi.map <- setNames(chebi.map[,1], rownames(chebi.map))
chebi.map[which(chebi.map=='')] <- names(chebi.map)[which(chebi.map=='')]
```

## Roast between-group

We write the z-score for the between-arm comparison of each analyte's 3 month difference from baseline from `ezlimma::limma_contrasts` to use in results.

```{r deltas}
# diff_mat file created in gb_ww_net_integration
diff.mat3 <- read.csv('data/soma_and_met_diff_mat.csv', row.names=1)

#need to eval this for below
grp.v <- pheno[paste0(colnames(diff.mat3), "_0"), "arm"]
contr.v <- c(RYGBvsDWM="RYGB-DWM")

#feature (analyte) stats from ezlimma
fs <- limma_contrasts(diff.mat3, grp=grp.v, contrast.v = c(RYGBvsDWM="RYGB-DWM"), cols=c("t", "P.Value", "adj.P.Val"))
fs.df <- data.frame(signif(fs, 4), CHEBI=chebi.map[rownames(fs)])
write.csv(fs.df, "results/deltadelta_t.csv")
```

Run roast.

```{r roast, eval=FALSE}
# read in objects with prepare_mesa_on_o2.Rmd
setwd("./results")
fs <- read.csv("deltadelta_t.csv", row.names = 1)
G.smpdb <- Gmat2gmt(smpdb_gmat)
nrot <- 2*10**5
res <- roast_contrasts(object=diff.mat3, G=G.smpdb, feat.tab=fs, grp=grp.v, contrast.v=contr.v, fun="mroast", 
                       nrot=nrot, name = paste0("RYGBvsDWM_nrot", nrot))
res <- res[order(res$RYGBvsDWM.Mixed.p),]
res.cols <- c("NGenes", grep("Mixed", colnames(res), value = TRUE))
res <- res[, res.cols]
write.csv(df_signif(res, 3), paste0("RYGBvsDWM_stats_nrot", nrot, "_roast.csv"))
setwd("..")
```

Roast barplot.

```{r roast_barplot, eval=FALSE}
#no rownames for ggplot2
pwys <- read.csv("results/RYGBvsDWM_nrot2e+05_mroast/RYGBvsDWM_nrot2e+05_mroast.csv")
colnames(pwys) <- sub("RYGBvsDWM.Mixed.", "", colnames(pwys), fixed = TRUE)
colnames(pwys)[1] <- "pwy.nm"
pwys$nlog10pv <- -log10(pwys$p)
# pwys.ss <- pwys[pwys$FDR < 0.01,]
pwys.ss <- pwys[1:5,]
pwys.ss$pwy.nm <- factor(pwys.ss$pwy.nm, levels=rev(pwys.ss$pwy.nm), ordered=TRUE)

ggp <- ggplot(data=pwys.ss, mapping=aes(x=pwy.nm, y=nlog10pv, fill=FDR)) + geom_col() + xlab("Pathway") + theme_bw() + 
  ylab("-log10(p-value)") + coord_flip() + theme(legend.title = element_text(size = 16), legend.text = element_text(size = 16),
                                                 axis.title.x=element_text(size=20), axis.text.x=element_text(size=12),
                                                 axis.text.y=element_text(size=24), axis.title.y = element_blank())
# fig will be horizontal in paper
ggsave("figures/pwy_sig_barplot.pdf", ggp, width=11, height=5)
```

Plot Roast pwys.

```{r plot_pwys, eval=FALSE}
setwd("./results")

fs <- read.csv("deltadelta_t.csv", row.names = 1)
#net plots
fs.z <- data.frame(z=fs$RYGBvsDWM.t, annot=fs$CHEBI)
rownames(fs.z) <- rownames(fs)
fs.z$annot[is.na(fs.z$annot)] <- rownames(fs.z)[is.na(fs.z$annot)]
new.chebi <- setdiff(names(chebi.map), rownames(fs.z))
new.chebi.df <- data.frame(z=NA, annot=chebi.map[new.chebi])
fs.z <- rbind(fs.z, new.chebi.df)

pwy.tmp <- read.csv("RYGBvsDWM_nrot2e+05_mroast/pathways/Beta_Alanine_Metabolism.csv", row.names = 1)
ntop <- 7
plot_pwy(feat.tab = fs.z, G.pwy = smpdb_gmt[["Beta-Alanine Metabolism"]], stat.colnm = "z", annot.col = "annot",
         gr=gr, ntop = ntop, alternative="two.sided", repel = TRUE, seed=0,
         name = paste0("../figures/Beta_Alanine_Metabolism_ntop", ntop))

# only 4 analytes intersect
pwy.tmp <- read.csv("RYGBvsDWM_nrot2e+05_mroast/pathways/Phospholipid_Biosynthesis.csv", row.names = 1)
ntop <- 7
plot_pwy(feat.tab = fs.z, G.pwy = smpdb_gmt[["Phospholipid Biosynthesis"]], stat.colnm = "z", annot.colnm = "annot",
         gr=gr, ntop = ntop, alternative="two.sided", repel = TRUE, seed=3,
         name = paste0("../figures/Phospholipid_Biosynthesis_ntop", ntop))

# graphical abstract combined BCAA, CNDP1, histidine
# ntop <- 6
# g.tmp <- smpdb_gmt[["Valine, Leucine and Isoleucine Degradation"]]
# g.tmp$genes <- c(g.tmp$genes, "CNDP1", "CHEBI:15971")
# pp <- plot_pwy(feat.tab = fs.z, G.pwy = g.tmp, stat.colnm = "z", annot.colnm = "annot",
#          gr=gr, ntop = ntop, alternative="two.sided", repel = TRUE, seed=0, name = NA)
# pdf(paste0("../figures/combined_ntop", ntop, ".pdf"), height = 5)
# plot(pp)
# dev.off()

setwd("..")
```

# Pathway mediation

We apply `CAMERA` to `Hitman` scores to test pathways. We need to know inter-gene correlation for method `cameraPR`.

```{r}
nms.tmp <- intersect(colnames(diff.mat3), rownames(diff.pheno12))
# even though individual analytes use subset of samples who don't have NA in pheno, this is best measure
igc <- interGeneCorrelation(diff.mat3[,nms.tmp], design=model.matrix(~diff.pheno12[nms.tmp, "arm"]))$correlation
```

## HbA1c

```{r deltas.HbA1c}
setwd("./results")
hm.soma <- data.frame(signif(hm.a1c.soma, 3), annot=soma.annot[rownames(hm.a1c.soma), "Target"])
hm.soma.ss <- hm.soma[!duplicated(soma.annot[rownames(hm.soma), "EntrezGeneSymbol"]),]
rownames(hm.soma.ss) <- soma.annot[rownames(hm.soma.ss), "EntrezGeneSymbol"]

hm.met <- data.frame(signif(hm.a1c.met, 3), annot=met.annot[rownames(hm.a1c.met), "BIOCHEMICAL"])
hm.met.ss <- hm.met[!duplicated(met.annot[rownames(hm.met), "CHEBI"]) & met.annot[rownames(hm.met), "CHEBI"] != "",]
rownames(hm.met.ss) <- met.annot[rownames(hm.met.ss), "CHEBI"]

hm.df <- rbind(hm.soma.ss, hm.met.ss)

cam.a1c  <- ezcamerapr(stats.tab=hm.df[, "EMY.chisq", drop=FALSE], G=smpdb_gmt, feat.tab=hm.df, alternative = "greater",
                       inter.gene.cor = igc, name="hba1c")
setwd("..")
```

We find no significant pathways.

`r kable(cam.a1c[1:3,])`

## HOMA-IR

```{r deltas.homair}
setwd("results")
hm.soma <- data.frame(signif(hm.homair.soma, 3), annot=soma.annot[rownames(hm.homair.soma), "Target"])
hm.soma.ss <- hm.soma[!duplicated(soma.annot[rownames(hm.soma), "EntrezGeneSymbol"]),]
rownames(hm.soma.ss) <- soma.annot[rownames(hm.soma.ss), "EntrezGeneSymbol"]

hm.met <- data.frame(signif(hm.homair.met, 3), annot=met.annot[rownames(hm.homair.met), "BIOCHEMICAL"])
hm.met.ss <- hm.met[!duplicated(met.annot[rownames(hm.met), "CHEBI"]) & met.annot[rownames(hm.met), "CHEBI"] != "",]
rownames(hm.met.ss) <- met.annot[rownames(hm.met.ss), "CHEBI"]

hm.df <- rbind(hm.soma.ss, hm.met.ss)

cam.homair <- ezcamerapr(stats.tab=hm.df[, "EMY.chisq", drop=FALSE], G=smpdb_gmt, feat.tab=hm.df, alternative = "greater",
                         inter.gene.cor = igc, name="homair")
setwd("..")
```

We find `r sum(cam.homair$EMY.chisq.FDR < FDR)` significant pathways.

`r kable(cam.homair[1:3,])`

## dins030

```{r deltas.dins030}
setwd("./results")
hm.soma <- data.frame(signif(hm.dins.soma, 3), annot=soma.annot[rownames(hm.dins.soma), "Target"])
hm.soma.ss <- hm.soma[!duplicated(soma.annot[rownames(hm.soma), "EntrezGeneSymbol"]),]
rownames(hm.soma.ss) <- soma.annot[rownames(hm.soma.ss), "EntrezGeneSymbol"]

hm.met <- data.frame(signif(hm.dins.met, 3), annot=met.annot[rownames(hm.dins.met), "BIOCHEMICAL"])
hm.met.ss <- hm.met[!duplicated(met.annot[rownames(hm.met), "CHEBI"]) & met.annot[rownames(hm.met), "CHEBI"] != "",]
rownames(hm.met.ss) <- met.annot[rownames(hm.met.ss), "CHEBI"]

hm.df <- rbind(hm.soma.ss, hm.met.ss)

hm.df[is.na(hm.df[, "EMY.chisq"]), "EMY.chisq"] <- 0
cam.dins  <- ezcamerapr(stats.tab=hm.df[, "EMY.chisq", drop=FALSE], G=smpdb_gmt, feat.tab=hm.df, alternative = "greater",
                        inter.gene.cor = igc, name="dins30")
setwd("..")
```

We find caffeine metabolism significant.

`r kable(cam.dins[1:3,])`

# Session info

```{r sessioninfo, include=TRUE}
devtools::session_info()
```

```{r check}
# Test expectations
stopifnot("HbA1c" %in% colnames(pheno))
stopifnot(pheno[grep("_0", rownames(pheno)), "dmcure"]==0)
stopifnot(diff.pheno["RADIO_3", "HbA1c"] == pheno["RADIO_3", "HbA1c"]-pheno["RADIO_0", "HbA1c"])
stopifnot(colnames(soma.mat) %in% rownames(pheno))
stopifnot(diff.pheno["RADIO_3", "HbA1c"] == pheno["RADIO_3", "HbA1c"] - pheno["RADIO_0", "HbA1c"])
#check match to soma_and_met_diff_mat.csv
stopifnot(abs(diff.soma.mat["SL000252", "BLUSH_3"] - -0.232048936) < 10**-6)
#from causal plot
dm <- diff.soma.mat["SL006694", grep("_3$", colnames(diff.soma.mat))]
stopifnot(dm < 0.5, dm > -2)
stopifnot(soma.annot["SL005168", "EntrezGeneSymbol"]=="GHR", 
          soma.annot["SL006694", "EntrezGeneSymbol"]=="CNDP1",
          met.annot["C1806", "BIOCHEMICAL"]=="retinol (Vitamin A)",
          met.annot["C34407", "BIOCHEMICAL"]=="isovalerylcarnitine")
stopifnot(paste0(rownames(diff.pheno12), "_3") %in% colnames(diff.soma.mat))
stopifnot(paste0(rownames(diff.pheno12), "_3") %in% rownames(diff.pheno))

stopifnot("HbA1c" %in% colnames(pheno))
stopifnot(diff.pheno["RADIO_3", "HbA1c"] == pheno["RADIO_3", "HbA1c"]-pheno["RADIO_0", "HbA1c"])

stopifnot(colnames(soma.mat) %in% rownames(pheno))

stopifnot(diff.pheno["RADIO_3", "HbA1c"] == pheno["RADIO_3", "HbA1c"] - pheno["RADIO_0", "HbA1c"])
#one rbp4 diff (for VENUE) is >60; others [-20, 20]
# stopifnot(diff.rbp4.ttr["RBP4", "IMAGE_3"] == rbp4.ttr["RBP4", "IMAGE_3"] - rbp4.ttr["RBP4", "IMAGE_0"])
#check match to gb_ww_net_integration/soma_and_met_diff_mat.csv
stopifnot(abs(diff.soma.mat["SL000252", "BLUSH_3"] - -0.232048936) < 10**-6)

# stopifnot(rownames(diff.pheno12)==rownames(diff.pheno12.hm))

#from causal plot
dm <- diff.soma.mat["SL006694", grep("_3$", colnames(diff.soma.mat))]
stopifnot(dm < 0.5, dm > -2)

stopifnot(soma.annot["SL005168", "EntrezGeneSymbol"]=="GHR", 
          soma.annot["SL006694", "EntrezGeneSymbol"]=="CNDP1",
          met.annot["C1806", "BIOCHEMICAL"]=="retinol (Vitamin A)",
          met.annot["C34407", "BIOCHEMICAL"]=="isovalerylcarnitine")

stopifnot(paste0(rownames(diff.pheno12), "_3") %in% colnames(diff.soma.mat))
stopifnot(paste0(rownames(diff.pheno12), "_3") %in% rownames(diff.pheno))

stopifnot(sum(smpdb_gmat["CHEBI:37373",]) == 1)
stopifnot("CHEBI:37373" %in% rownames(diff.mat3))

# cor soma vs met
stopifnot(order(-abs(as.numeric(cor.array[,,"r"]))) == order(as.numeric(cor.array[,, "p"])))
stopifnot(cor.r["OMD", "pro-hydroxy-pro"] == 0.521)
# signif(cor.array[,,"p"][wm], 3)

stopifnot(nrow(cor.r) <= 56)
```